# Copyright (c) 2015 Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---

- hosts: Create a Key Pair
  handlers:
    - name: Signal a wait condition handle
      command: cfn-signal -s true -r 'The public key file imported.' {{ key_name_wait_condition_handle }}
  tasks:
    - name: Create an RSA key pair
      user: name={{ ansible_user_id }} generate_ssh_key=yes
      register: user_result
    - name: Import a key pair
      ec2_key:
        name: "{{ stack }}"
        key_material: "{{ user_result.ssh_public_key }}"
        region: "{{ region }}"
        wait: yes
        state: present
      notify:
        - Signal a wait condition handle
    - name: Set the key pair used by BOSH
      set_fact:
        bosh_default_key_name: "{{ stack }}"
        bosh_private_key: "{{ user_result.ssh_key_file }}"

- name: Install Ruby
  hosts: jump-boxes
  roles:
    - rvm_io.rvm1-ruby
  post_tasks:
    # http://www.nokogiri.org/tutorials/installing_nokogiri.html#ubuntu___debian
    - name: Install libgmp
      apt: name=libgmp-dev state=present
      become: yes
      when: "'ruby-2.2.3' in rvm1_rubies and ansible_distribution == 'Ubuntu'"
  become: yes

- name: Install command line interfaces
  hosts: jump-boxes
  roles:
    - bosh-init
    - bosh-cli
    - cf-cli 
    - uaac
  become: yes

- name: Install BOSH
  hosts: jump-boxes
  pre_tasks:
    - name: Configure the Director
      set_fact:
        bosh_gateway: "{{ bosh_range | nthhost(1) }}"                                   
        bosh_dns: "{{ vpc_cidr_block | nthhost(2) }}"
        bosh_private_ip: "{{ bosh_range | nthhost(4) }}" 
        bosh_region: "{{ region }}"
        bosh_ntp: "{{ ntp_server }}"
    - name: Generate passwords
      set_fact: "{{ item }}=\"{{ lookup('password', playbook_dir + '/credentials/' + item + ' chars=ascii_letters,digits length=16') }}\""
      with_items:
        - bosh_nats_password
        - bosh_redis_password
        - bosh_postgres_password
        - bosh_registry_password
        - bosh_director_password
        - bosh_agent_password
        - bosh_admin_password
        - bosh_hm_password
  roles:
    - bosh

- name: Deploy Cloud Foundry
  hosts: jump-boxes
  pre_tasks:
    - name: Generate passwords
      set_fact: "{{ item }}=\"{{ lookup('password', playbook_dir + '/credentials/' + item + ' chars=ascii_letters,digits length=16') }}\""
      with_items:
        - cf_bulk_api_password
        - cf_ccdb_encryption_key
        - cf_staging_upload_password
        - cf_ccdb_user_password
        - cf_loggregator_endpoint_shared_secret
        - cf_nats_password
        - cf_admin_secret
        - cf_cc_client_secret
        - cf_cc_routing_secret
        - cf_cloud_controller_username_lookup_secret
        - cf_doppler_secret
        - cf_gorouter_secret
        - cf_login_client_secret
        - cf_notifications_client_secret
        - cf_uaadb_user_password

# vi:et:sw=2 ts=2 sts=2 ft=ansible
