# Copyright (c) 2015 Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---

- hosts: all
  pre_tasks:
    - file: path={{ item }} state=directory
      with_items:
        - "{{ consul_config_dir }}"
        - "{{ consul_data_dir }}"
      become: yes
    - copy:
        content: "{{ consul_basic_config | default() | to_nice_json }}"
        dest: "{{ consul_config_dir }}/basic_config.json"
        validate: python -mjson.tool %s
      become: yes
    - set_fact: consul_options="{{ consul_options | union(['-recursor ' + item]) }}"
      with_items: ansible_local['resolver']['nameservers'] | difference(['127.0.0.1']) | list
  roles:
    - consul
  post_tasks:
    - wait_for: port={{ consul_basic_config['ports']['dns'] | default(8600) }}
    - lineinfile: dest=/etc/resolv.conf regexp='^nameserver 127\.0\.0\.1$'
                  insertbefore='^nameserver' line='nameserver 127.0.0.1'
    - lineinfile: dest=/etc/resolv.conf regexp='^search'
                  line='search service.{{ consul_domain }} node.{{ consul_dc }}.{{ consul_domain }}'
    - setup: filter=ansible_local 
  become: yes

# vi:et:sw=2 ts=2 sts=2 ft=ansible
